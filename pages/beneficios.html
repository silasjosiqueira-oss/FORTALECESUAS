<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Benefícios – Sistema de Atendimento Social</title>

  <!-- CSS base -->
  <link rel="stylesheet" href="../css/base/reset.css">
  <link rel="stylesheet" href="../css/base/variables.css">
  <link rel="stylesheet" href="../css/base/typography.css">
  <link rel="stylesheet" href="../css/layout/sidebar.css">
  <link rel="stylesheet" href="../css/layout/header.css">
  <link rel="stylesheet" href="../css/layout/grid.css">
  <link rel="stylesheet" href="../css/layout/responsive.css">
  <link rel="stylesheet" href="../css/components/buttons.css">
  <link rel="stylesheet" href="../css/components/cards.css">
  <link rel="stylesheet" href="../css/components/forms.css">
  <link rel="stylesheet" href="../css/components/modal.css">
  <link rel="stylesheet" href="../css/main.css">

  <!-- Fontes/Ícones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

</head>
<body>

  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar__header">
        <div class="sidebar__logo">FS</div>
        <h1 class="sidebar__title">FORTALECE SUAS</h1>
      </div>
      <nav class="sidebar__nav">
        <ul>
          <li><a href="index.html"><i class="fas fa-tachometer-alt"></i><span>Inicio</span></a></li>
          <li><a href="atendimento.html"><i class="fas fa-users"></i><span>Atendimentos</span></a></li>
          <li><a href="beneficios.html" class="active"><i class="fas fa-hand-holding-heart"></i><span>Benefícios</span></a></li>
          <li><a href="agenda.html"><i class="fas fa-calendar-alt"></i><span>Agenda</span></a></li>
          <li><a href="atividades.html"><i class="fas fa-users-cog"></i><span>Grupos/Atividades</span></a></li>
          <li><a href="programas.html"><i class="fas fa-clipboard-list"></i><span>Programas</span></a></li>
          <li><a href="relatorios.html"><i class="fas fa-file-alt"></i><span>Relatórios</span></a></li>
          <li><a href="estatisticas.html"><i class="fas fa-chart-bar"></i><span>Estatísticas</span></a></li>
          <li><a href="cadastros.html"><i class="fas fa-database"></i><span>Cadastros</span></a></li>
          <li><a href="estoque.html"><i class="fas fa-boxes"></i><span>Estoque</span></a></li>
          <li><a href="ferramentas.html"><i class="fas fa-tools"></i><span>Ferramentas</span></a></li>
          <li><a href="configuracoes.html"><i class="fas fa-cogs"></i><span>Configurações</span></a></li>
          <li><a href="suporte.html"><i class="fas fa-life-ring"></i><span>Suporte</span></a></li>
          <li><a href="login.html"><i class="fas fa-sign-out-alt"></i><span>Logoff</span></a></li>
        </ul>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main-content">
      <header class="main-header">
        <div class="header-title">
          <h2>Sistema Fortalece - Assistência Social</h2>
        </div>
        <div class="header-actions">
          <button class="btn btn--icon"><i class="fas fa-bell"></i><span class="badge">3</span></button>
          <button class="btn btn--icon"><i class="fas fa-cog"></i></button>
          <button class="btn btn--secondary" onclick="location.href='login.html'"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </div>
      </header>

      <div class="content-wrapper">
        <!-- Abas -->
        <div class="card">
          <div class="tabs" role="tablist">
            <button class="tab active" data-tab="mov" role="tab"><i class="fa-solid fa-arrows-rotate"></i> Movimentação</button>
            <button class="tab" data-tab="bolsa" role="tab"><i class="fa-solid fa-people-roof"></i> Bolsa Família</button>
            <button class="tab" data-tab="eventuais" role="tab"><i class="fa-solid fa-box-open"></i> Benefícios Eventuais</button>
            <button class="tab" data-tab="bpc" role="tab"><i class="fa-solid fa-hands-holding-circle"></i> BPC</button>
            <button class="tab" data-tab="lista" role="tab"><i class="fa-solid fa-list"></i> Lista de Beneficiários</button>
          </div>

          <!-- Movimentação de Benefícios -->
          <section id="tab-mov" class="tab-content active" aria-labelledby="Movimentação de Benefícios">
            <div class="card">
              <div class="card-header">
                <h3>Movimentação de Benefícios – Controle Geral</h3>
                <div class="inline-actions">
                  <button class="btn btn--primary" id="btn-nova-mov"><i class="fa fa-plus"></i> Nova Movimentação</button>
                  <button class="btn btn--outline" id="btn-filtrar-mov"><i class="fa fa-search"></i> Pesquisar</button>
                  <button class="btn btn--outline" id="btn-limpar-mov"><i class="fa fa-eraser"></i> Limpar</button>
                </div>
              </div>

              <div class="filtros-container">
                <div class="form-group">
                  <label class="form-label">Benefício</label>
                  <select class="form-input" id="mov-beneficio">
                    <option value="">Todos</option>
                    <option>Bolsa Família</option>
                    <option>Benefício Eventual</option>
                    <option>BPC</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Nome / CPF</label>
                  <input class="form-input" id="mov-nomecpf" placeholder="Digite nome ou CPF" />
                </div>
                <div class="form-group">
                  <label class="form-label">Período</label>
                  <div class="date-range">
                    <input type="date" class="form-input" id="mov-inicio" />
                    <span>até</span>
                    <input type="date" class="form-input" id="mov-fim" />
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Situação</label>
                  <select class="form-input" id="mov-situacao">
                    <option value="">Todas</option>
                    <option>Ativo</option>
                    <option>Suspenso</option>
                    <option>Cancelado</option>
                  </select>
                </div>
              </div>

              <div class="table-container">
                <table id="tabela-mov">
                  <thead>
                    <tr>
                      <th>Benefício</th>
                      <th>Nome</th>
                      <th>CPF</th>
                      <th>Data</th>
                      <th>Ação</th>
                      <th>Situação</th>
                      <th>Unidade</th>
                      <th>Opções</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>

                <!-- Paginação -->
                <div class="pagination" id="pagination-mov" style="display: flex; justify-content: center; align-items: center; gap: 1rem; padding: 1rem;">
                  <button class="btn btn--outline btn-sm" id="prev-mov">Anterior</button>
                  <span id="page-info-mov">Página 1 de 1</span>
                  <button class="btn btn--outline btn-sm" id="next-mov">Próxima</button>
                </div>
              </div>
            </div>
          </section>

          <!-- Bolsa Família -->
          <section id="tab-bolsa" class="tab-content" aria-labelledby="Bolsa Família">
            <div class="card">
              <div class="card-header">
                <h3>Bolsa Família – Listagem & Dados Cadastrais</h3>
                <div class="inline-actions">
                  <button class="btn btn--primary" id="btn-importar-bolsa"><i class="fa fa-file-import"></i> Importar</button>
                  <button class="btn btn--outline" id="btn-novo-bolsa"><i class="fa fa-plus"></i> Novo</button>
                  <button class="btn btn--outline" id="btn-exportar-bolsa"><i class="fa fa-download"></i> Exportar</button>
                </div>
              </div>

              <div class="filtros-container">
                <div class="form-group">
                  <label class="form-label">Responsável Familiar (RF)</label>
                  <input class="form-input" id="bolsa-rf" placeholder="Nome do RF" />
                </div>
                <div class="form-group">
                  <label class="form-label">NIS</label>
                  <input class="form-input" id="bolsa-nis" placeholder="NIS" />
                </div>
                <div class="form-group">
                  <label class="form-label">Entrada / Renovação</label>
                  <div class="date-range">
                    <input type="date" class="form-input" id="bolsa-entrada" />
                    <span>até</span>
                    <input type="date" class="form-input" id="bolsa-renovacao" />
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Situação</label>
                  <select class="form-input" id="bolsa-situacao">
                    <option value="">Todas</option>
                    <option>Ativo</option>
                    <option>Suspenso</option>
                    <option>Em Análise</option>
                  </select>
                </div>
              </div>

              <div class="table-container">
                <table id="tabela-bolsa">
                  <thead>
                    <tr>
                      <th>Responsável Familiar</th>
                      <th>NIS</th>
                      <th>Grupo Familiar</th>
                      <th>Entrada</th>
                      <th>Renovação</th>
                      <th>Situação</th>
                      <th>Opções</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>

                <!-- Paginação -->
                <div class="pagination" id="pagination-bolsa" style="display: flex; justify-content: center; align-items: center; gap: 1rem; padding: 1rem;">
                  <button class="btn btn--outline btn-sm" id="prev-bolsa">Anterior</button>
                  <span id="page-info-bolsa">Página 1 de 1</span>
                  <button class="btn btn--outline btn-sm" id="next-bolsa">Próxima</button>
                </div>

                <p class="helper">Dica: É possível anexar PDFs/planilhas oficiais ao registro para consulta rápida.</p>
              </div>
            </div>
          </section>

          <!-- Benefícios Eventuais -->
          <section id="tab-eventuais" class="tab-content" aria-labelledby="Benefícios Eventuais">
            <div class="card">
              <div class="card-header">
                <h3>Benefícios Eventuais – Gestão de Auxílios</h3>
                <div class="inline-actions">
                  <button class="btn btn--primary" id="btn-novo-eventual"><i class="fa fa-plus"></i> Novo Auxílio</button>
                  <button class="btn btn--outline" id="btn-filtrar-eventual"><i class="fa fa-search"></i> Pesquisar</button>
                </div>
              </div>

              <div class="filtros-container">
                <div class="form-group">
                  <label class="form-label">Tipo</label>
                  <select class="form-input" id="eventual-tipo">
                    <option value="">Todos</option>
                    <option>Cesta Básica</option>
                    <option>Aluguel Social</option>
                    <option>Natalidade</option>
                    <option>Funeral</option>
                    <option>Transporte</option>
                    <option>Outros</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Nome / CPF</label>
                  <input class="form-input" id="eventual-nomecpf" placeholder="Digite nome ou CPF" />
                </div>
                <div class="form-group">
                  <label class="form-label">Período</label>
                  <div class="date-range">
                    <input type="date" class="form-input" id="eventual-inicio" />
                    <span>até</span>
                    <input type="date" class="form-input" id="eventual-fim" />
                  </div>
                </div>
              </div>

              <div class="table-container">
                <table id="tabela-eventuais">
                  <thead>
                    <tr>
                      <th>Tipo</th>
                      <th>Beneficiário</th>
                      <th>CPF</th>
                      <th>Valor</th>
                      <th>Data</th>
                      <th>Situação</th>
                      <th>Opções</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>

                <!-- Paginação -->
                <div class="pagination" id="pagination-eventuais" style="display: flex; justify-content: center; align-items: center; gap: 1rem; padding: 1rem;">
                  <button class="btn btn--outline btn-sm" id="prev-eventuais">Anterior</button>
                  <span id="page-info-eventuais">Página 1 de 1</span>
                  <button class="btn btn--outline btn-sm" id="next-eventuais">Próxima</button>
                </div>
              </div>
            </div>
          </section>

          <!-- BPC -->
          <section id="tab-bpc" class="tab-content" aria-labelledby="BPC">
            <div class="card">
              <div class="card-header">
                <h3>BPC – Benefício de Prestação Continuada</h3>
                <div class="inline-actions">
                  <button class="btn btn--primary" id="btn-novo-bpc"><i class="fa fa-plus"></i> Novo</button>
                  <button class="btn btn--outline" id="btn-filtrar-bpc"><i class="fa fa-search"></i> Pesquisar</button>
                </div>
              </div>

              <div class="filtros-container">
                <div class="form-group">
                  <label class="form-label">Nome / CPF</label>
                  <input class="form-input" id="bpc-nomecpf" placeholder="Digite nome ou CPF" />
                </div>
                <div class="form-group">
                  <label class="form-label">NIS</label>
                  <input class="form-input" id="bpc-nis" placeholder="NIS" />
                </div>
                <div class="form-group">
                  <label class="form-label">Situação INSS</label>
                  <select class="form-input" id="bpc-situacao">
                    <option value="">Todas</option>
                    <option>Em Análise</option>
                    <option>Concedido</option>
                    <option>Indeferido</option>
                    <option>Suspenso</option>
                    <option>Cancelado</option>
                  </select>
                </div>
              </div>

              <div class="table-container">
                <table id="tabela-bpc">
                  <thead>
                    <tr>
                      <th>Beneficiário</th>
                      <th>CPF</th>
                      <th>NIS</th>
                      <th>Categoria</th>
                      <th>Protocolo</th>
                      <th>Situação</th>
                      <th>Opções</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>

                <!-- Paginação -->
                <div class="pagination" id="pagination-bpc" style="display: flex; justify-content: center; align-items: center; gap: 1rem; padding: 1rem;">
                  <button class="btn btn--outline btn-sm" id="prev-bpc">Anterior</button>
                  <span id="page-info-bpc">Página 1 de 1</span>
                  <button class="btn btn--outline btn-sm" id="next-bpc">Próxima</button>
                </div>
              </div>
            </div>
          </section>

          <!-- Lista de Beneficiários -->
          <section id="tab-lista" class="tab-content" aria-labelledby="Lista de Beneficiários">
            <div class="card">
              <div class="card-header">
                <h3>Lista de Beneficiários – Visão Consolidada</h3>
                <div class="inline-actions">
                  <button class="btn btn--outline" id="btn-exportar-lista"><i class="fa fa-download"></i> Exportar</button>
                  <button class="btn btn--outline" id="btn-limpar-lista"><i class="fa fa-eraser"></i> Limpar Filtros</button>
                </div>
              </div>

              <div class="filtros-container">
                <div class="form-group">
                  <label class="form-label">Benefício</label>
                  <select class="form-input" id="lista-beneficio">
                    <option value="">Todos</option>
                    <option>Bolsa Família</option>
                    <option>Benefício Eventual</option>
                    <option>BPC</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Nome / CPF</label>
                  <input class="form-input" id="lista-nomecpf" placeholder="Digite nome ou CPF" />
                </div>
                <div class="form-group">
                  <label class="form-label">Unidade</label>
                  <select class="form-input" id="lista-unidade">
                    <option value="">Todas</option>
                    <option>CRAS</option>
                    <option>CREAS</option>
                    <option>Sec. Assistência</option>
                  </select>
                </div>
              </div>

              <div class="table-container">
                <table id="tabela-lista">
                  <thead>
                    <tr>
                      <th>Nome</th>
                      <th>CPF</th>
                      <th>Benefício</th>
                      <th>Situação</th>
                      <th>Início</th>
                      <th>Unidade</th>
                      <th>Opções</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>

                <!-- Paginação -->
                <div class="pagination" id="pagination-lista" style="display: flex; justify-content: center; align-items: center; gap: 1rem; padding: 1rem;">
                  <button class="btn btn--outline btn-sm" id="prev-lista">Anterior</button>
                  <span id="page-info-lista">Página 1 de 1</span>
                  <button class="btn btn--outline btn-sm" id="next-lista">Próxima</button>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal genérico para detalhes -->
  <div id="modal-detalhes" class="modal" aria-hidden="true">
    <div class="modal__content">
      <button class="modal__close" id="btn-fechar-modal" aria-label="Fechar">&times;</button>
      <div class="modal__header">
        <h2 id="modal-titulo">Detalhes</h2>
      </div>
      <div class="detalhes-grid" id="modal-corpo">
        <!-- preenchido via JS -->
      </div>
      <div class="modal__footer">
        <button class="btn btn--outline" id="modal-cancelar">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div class="loading-overlay" id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div class="loading-spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #483D8B; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    <span id="loading-message" style="margin-left: 1rem; color: white;">Carregando...</span>
  </div>

  <script>
// ===== Configuração da API =====
const API_BASE_URL = 'http://localhost:3000';

// ===== Variáveis globais =====
let currentData = {
    mov: [],
    bolsa: [],
    eventuais: [],
    bpc: []
};

// Estado de paginação
let pagination = {
    mov: { page: 1, perPage: 10, total: 0 },
    bolsa: { page: 1, perPage: 10, total: 0 },
    eventuais: { page: 1, perPage: 10, total: 0 },
    bpc: { page: 1, perPage: 10, total: 0 },
    lista: { page: 1, perPage: 10, total: 0 }
};

// Dados filtrados
let filteredData = {
    mov: [],
    bolsa: [],
    eventuais: [],
    bpc: []
};

// Flag para evitar duplicação de listeners
let listenersInitialized = false;

// ===== Inicialização =====
document.addEventListener('DOMContentLoaded', function() {
    initializeElements();
    setupEventListeners();
    setupModaisCriacao();
    loadAllData();
    setupPagination();
});

function initializeElements() {
    // Obter referências das tabelas
    window.tbodyMov = document.querySelector('#tabela-mov tbody');
    window.tbodyBolsa = document.querySelector('#tabela-bolsa tbody');
    window.tbodyEvent = document.querySelector('#tabela-eventuais tbody');
    window.tbodyBpc = document.querySelector('#tabela-bpc tbody');
    window.tbodyLista = document.querySelector('#tabela-lista tbody');
}

function setupEventListeners() {
    if (listenersInitialized) return;
    listenersInitialized = true;

    // Configurar abas
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(btn => {
        btn.addEventListener('click', () => {
            tabs.forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            btn.classList.add('active');
            const id = btn.dataset.tab;
            document.getElementById(`tab-${id}`).classList.add('active');
        });
    });

    // Botões de exportação
    document.getElementById('btn-exportar-bolsa')?.addEventListener('click', exportarBolsa);
    document.getElementById('btn-exportar-lista')?.addEventListener('click', exportarLista);
    document.getElementById('btn-importar-bolsa')?.addEventListener('click', importarBolsa);

    // Botões de novo registro
    document.getElementById('btn-nova-mov')?.addEventListener('click', () => abrirModalCriacao('mov'));
    document.getElementById('btn-novo-bolsa')?.addEventListener('click', () => abrirModalCriacao('bolsa'));
    document.getElementById('btn-novo-eventual')?.addEventListener('click', () => abrirModalCriacao('eventual'));
    document.getElementById('btn-novo-bpc')?.addEventListener('click', () => abrirModalCriacao('bpc'));

    // Botões de filtro
    document.getElementById('btn-filtrar-mov')?.addEventListener('click', filtrarMovimentacao);
    document.getElementById('btn-filtrar-eventual')?.addEventListener('click', filtrarEventuais);
    document.getElementById('btn-filtrar-bpc')?.addEventListener('click', filtrarBPC);
    document.getElementById('btn-limpar-mov')?.addEventListener('click', limparFiltrosMov);
    document.getElementById('btn-limpar-lista')?.addEventListener('click', limparFiltrosLista);

    // Configurar modal de detalhes
    document.getElementById('btn-fechar-modal')?.addEventListener('click', fecharModal);
    document.getElementById('modal-cancelar')?.addEventListener('click', fecharModal);
}

// ===== PAGINAÇÃO =====
function setupPagination() {
    ['mov', 'bolsa', 'eventuais', 'bpc', 'lista'].forEach(type => {
        document.getElementById(`prev-${type}`)?.addEventListener('click', () => changePage(type, -1));
        document.getElementById(`next-${type}`)?.addEventListener('click', () => changePage(type, 1));
    });
}

function changePage(type, direction) {
    const state = pagination[type];
    const newPage = state.page + direction;

    if (newPage < 1 || newPage > Math.ceil(state.total / state.perPage)) {
        return;
    }

    state.page = newPage;

    // Re-renderizar a tabela específica
    if (type === 'mov') renderMov();
    if (type === 'bolsa') renderBolsa();
    if (type === 'eventuais') renderEventuais();
    if (type === 'bpc') renderBpc();
    if (type === 'lista') renderLista();
}

function updatePaginationInfo(type) {
    const state = pagination[type];
    const totalPages = Math.ceil(state.total / state.perPage);
    const pageInfo = document.getElementById(`page-info-${type}`);

    if (pageInfo) {
        pageInfo.textContent = `Página ${state.page} de ${totalPages || 1} (${state.total} registros)`;
    }

    // Habilitar/desabilitar botões
    const prevBtn = document.getElementById(`prev-${type}`);
    const nextBtn = document.getElementById(`next-${type}`);

    if (prevBtn) prevBtn.disabled = state.page === 1;
    if (nextBtn) nextBtn.disabled = state.page >= totalPages || totalPages === 0;
}

function getPaginatedData(data, type) {
    const state = pagination[type];
    const start = (state.page - 1) * state.perPage;
    const end = start + state.perPage;
    return data.slice(start, end);
}

// ===== MODAIS DE CRIAÇÃO =====
function setupModaisCriacao() {
    criarModalMovimentacao();
    criarModalBolsa();
    criarModalEventual();
    criarModalBPC();
}

function criarModalMovimentacao() {
    const modalHTML = `
    <div id="modal-criar-mov" class="modal" aria-hidden="true" style="display: none;">
        <div class="modal__content modal__content--large">
            <button class="modal__close" id="close-mov">&times;</button>
            <div class="modal__header">
                <h2>Nova Movimentação de Benefício</h2>
            </div>
            <div class="modal__body">
                <form id="form-movimentacao" class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Tipo de Benefício *</label>
                        <select class="form-input" name="beneficio" required>

                            <option value="Bolsa Família">Bolsa Família</option>
                            <option value="Benefício Eventual">Benefício Eventual</option>
                            <option value="BPC">BPC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nome do Beneficiário *</label>
                        <input type="text" class="form-input" name="nome" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CPF</label>
                        <input type="text" class="form-input" name="cpf" maxlength="14">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data da Movimentação *</label>
                        <input type="date" class="form-input" name="data" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de Ação *</label>
                        <select class="form-input" name="acao" required>
                            <option value="">Selecione...</option>
                            <option value="Inclusão">Inclusão</option>
                            <option value="Atualização">Atualização</option>
                            <option value="Suspensão">Suspensão</option>
                            <option value="Cancelamento">Cancelamento</option>
                            <option value="Reativação">Reativação</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Situação *</label>
                        <select class="form-input" name="situacao" required>
                            <option value="">Selecione...</option>
                            <option value="Ativo">Ativo</option>
                            <option value="Suspenso">Suspenso</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unidade/Setor</label>
                        <input type="text" class="form-input" name="unidade">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Observações</label>
                        <textarea class="form-input" name="observacoes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button class="btn btn--outline" id="cancel-mov">Cancelar</button>
                <button class="btn btn--primary" id="save-mov">Salvar Movimentação</button>
            </div>
        </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    document.getElementById('close-mov').addEventListener('click', () => fecharModalCriacao('mov'));
    document.getElementById('cancel-mov').addEventListener('click', () => fecharModalCriacao('mov'));
    document.getElementById('save-mov').addEventListener('click', criarMovimentacao);
}

function criarModalBolsa() {
    const modalHTML = `
    <div id="modal-criar-bolsa" class="modal" aria-hidden="true" style="display: none;">
        <div class="modal__content modal__content--large">
            <button class="modal__close" id="close-bolsa">&times;</button>
            <div class="modal__header">
                <h2>Novo Registro - Bolsa Família</h2>
            </div>
            <div class="modal__body">
                <form id="form-bolsa" class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Responsável Familiar *</label>
                        <input type="text" class="form-input" name="rf" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">NIS *</label>
                        <input type="text" class="form-input" name="nis" maxlength="11" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CPF do Responsável</label>
                        <input type="text" class="form-input" name="cpf" maxlength="14">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantidade no Grupo Familiar *</label>
                        <input type="number" class="form-input" name="grupo" min="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Entrada *</label>
                        <input type="date" class="form-input" name="entrada" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Renovação</label>
                        <input type="date" class="form-input" name="renovacao">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Situação *</label>
                        <select class="form-input" name="situacao" required>
                            <option value="">Selecione...</option>
                            <option value="Ativo">Ativo</option>
                            <option value="Suspenso">Suspenso</option>
                            <option value="Em Análise">Em Análise</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Observações</label>
                        <textarea class="form-input" name="observacoes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button class="btn btn--outline" id="cancel-bolsa">Cancelar</button>
                <button class="btn btn--primary" id="save-bolsa">Salvar Registro</button>
            </div>
        </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    document.getElementById('close-bolsa').addEventListener('click', () => fecharModalCriacao('bolsa'));
    document.getElementById('cancel-bolsa').addEventListener('click', () => fecharModalCriacao('bolsa'));
    document.getElementById('save-bolsa').addEventListener('click', criarBolsa);
}

function criarModalEventual() {
    const modalHTML = `
    <div id="modal-criar-eventual" class="modal" aria-hidden="true" style="display: none;">
        <div class="modal__content modal__content--large">
            <button class="modal__close" id="close-eventual">&times;</button>
            <div class="modal__header">
                <h2>Novo Benefício Eventual</h2>
            </div>
            <div class="modal__body">
                <form id="form-eventual" class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Tipo de Benefício *</label>
                        <select class="form-input" name="tipo" required>
                            <option value="">Selecione...</option>
                            <option value="Cesta Básica">Cesta Básica</option>
                            <option value="Aluguel Social">Aluguel Social</option>
                            <option value="Natalidade">Natalidade</option>
                            <option value="Funeral">Funeral</option>
                            <option value="Transporte">Transporte</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nome do Beneficiário *</label>
                        <input type="text" class="form-input" name="nome" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CPF</label>
                        <input type="text" class="form-input" name="cpf" maxlength="14">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valor *</label>
                        <input type="number" class="form-input" name="valor" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Concessão *</label>
                        <input type="date" class="form-input" name="data" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Situação *</label>
                        <select class="form-input" name="situacao" required>
                            <option value="">Selecione...</option>
                            <option value="Ativo">Ativo</option>
                            <option value="Entregue">Entregue</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Observações</label>
                        <textarea class="form-input" name="observacoes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button class="btn btn--outline" id="cancel-eventual">Cancelar</button>
                <button class="btn btn--primary" id="save-eventual">Salvar Benefício</button>
            </div>
        </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    document.getElementById('close-eventual').addEventListener('click', () => fecharModalCriacao('eventual'));
    document.getElementById('cancel-eventual').addEventListener('click', () => fecharModalCriacao('eventual'));
    document.getElementById('save-eventual').addEventListener('click', criarEventual);
}

function criarModalBPC() {
    const modalHTML = `
    <div id="modal-criar-bpc" class="modal" aria-hidden="true" style="display: none;">
        <div class="modal__content modal__content--large">
            <button class="modal__close" id="close-bpc">&times;</button>
            <div class="modal__header">
                <h2>Novo Registro - BPC</h2>
            </div>
            <div class="modal__body">
                <form id="form-bpc" class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Nome do Beneficiário *</label>
                        <input type="text" class="form-input" name="nome" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CPF *</label>
                        <input type="text" class="form-input" name="cpf" maxlength="14" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">NIS *</label>
                        <input type="text" class="form-input" name="nis" maxlength="11" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categoria *</label>
                        <select class="form-input" name="categoria" required>
                            <option value="">Selecione...</option>
                            <option value="Idoso">Idoso</option>
                            <option value="Pessoa com Deficiência">Pessoa com Deficiência</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Número do Protocolo</label>
                        <input type="text" class="form-input" name="protocolo">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Situação *</label>
                        <select class="form-input" name="situacao" required>
                            <option value="">Selecione...</option>
                            <option value="Em Análise">Em Análise</option>
                            <option value="Concedido">Concedido</option>
                            <option value="Indeferido">Indeferido</option>
                            <option value="Suspenso">Suspenso</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Observações</label>
                        <textarea class="form-input" name="observacoes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button class="btn btn--outline" id="cancel-bpc">Cancelar</button>
                <button class="btn btn--primary" id="save-bpc">Salvar Registro</button>
            </div>
        </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    document.getElementById('close-bpc').addEventListener('click', () => fecharModalCriacao('bpc'));
    document.getElementById('cancel-bpc').addEventListener('click', () => fecharModalCriacao('bpc'));
    document.getElementById('save-bpc').addEventListener('click', criarBPC);
}

function abrirModalCriacao(tipo) {
    const modal = document.getElementById(`modal-criar-${tipo}`);
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('modal--open');
        modal.setAttribute('aria-hidden', 'false');
    }
}

function fecharModalCriacao(tipo) {
    const modal = document.getElementById(`modal-criar-${tipo}`);
    const form = document.getElementById(`form-${tipo}`);

    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('modal--open');
        modal.setAttribute('aria-hidden', 'true');
    }
    if (form) {
        form.reset();
    }
}

// ===== FUNÇÕES DE CRIAÇÃO =====
async function criarMovimentacao() {
    const form = document.getElementById('form-movimentacao');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const formData = new FormData(form);
    const data = {
        beneficio: sanitizeInput(formData.get('beneficio')),
        nome: sanitizeInput(formData.get('nome')),
        cpf: sanitizeInput(formData.get('cpf')),
        data: formData.get('data'),
        acao: sanitizeInput(formData.get('acao')),
        situacao: sanitizeInput(formData.get('situacao')),
        unidade: sanitizeInput(formData.get('unidade')),
        observacoes: sanitizeInput(formData.get('observacoes'))
    };

    if (data.cpf && !validarCPF(data.cpf)) {
        showNotification('CPF inválido', 'error');
        return;
    }

    try {
        showLoading('Criando movimentação...');
        await addMovimentacao(data);
        showNotification('Movimentação criada com sucesso!', 'success');
        fecharModalCriacao('mov');
        await loadAllData();
    } catch (error) {
        showNotification(error.message || 'Erro ao criar movimentação', 'error');
    } finally {
        hideLoading();
    }
}

async function criarBolsa() {
    const form = document.getElementById('form-bolsa');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const formData = new FormData(form);
    const data = {
        rf: sanitizeInput(formData.get('rf')),
        nis: sanitizeInput(formData.get('nis')),
        cpf: sanitizeInput(formData.get('cpf')),
        grupo: formData.get('grupo'),
        entrada: formData.get('entrada'),
        renovacao: formData.get('renovacao'),
        situacao: sanitizeInput(formData.get('situacao')),
        observacoes: sanitizeInput(formData.get('observacoes'))
    };

    if (data.cpf && !validarCPF(data.cpf)) {
        showNotification('CPF inválido', 'error');
        return;
    }

    if (data.nis && !validarNIS(data.nis)) {
        showNotification('NIS inválido', 'error');
        return;
    }

    try {
        showLoading('Criando registro do Bolsa Família...');
        await addBolsaFamilia(data);
        showNotification('Registro do Bolsa Família criado com sucesso!', 'success');
        fecharModalCriacao('bolsa');
        await loadAllData();
    } catch (error) {
        showNotification(error.message || 'Erro ao criar registro', 'error');
    } finally {
        hideLoading();
    }
}

async function criarEventual() {
    const form = document.getElementById('form-eventual');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const formData = new FormData(form);
    const data = {
        tipo: sanitizeInput(formData.get('tipo')),
        nome: sanitizeInput(formData.get('nome')),
        cpf: sanitizeInput(formData.get('cpf')),
        valor: parseFloat(formData.get('valor')),
        data: formData.get('data'),
        situacao: sanitizeInput(formData.get('situacao')),
        observacoes: sanitizeInput(formData.get('observacoes'))
    };

    if (data.cpf && !validarCPF(data.cpf)) {
        showNotification('CPF inválido', 'error');
        return;
    }

    try {
        showLoading('Criando benefício eventual...');
        await addBeneficioEventual(data);
        showNotification('Benefício eventual criado com sucesso!', 'success');
        fecharModalCriacao('eventual');
        await loadAllData();
    } catch (error) {
        showNotification(error.message || 'Erro ao criar benefício eventual', 'error');
    } finally {
        hideLoading();
    }
}

async function criarBPC() {
    const form = document.getElementById('form-bpc');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const formData = new FormData(form);
    const data = {
        nome: sanitizeInput(formData.get('nome')),
        cpf: sanitizeInput(formData.get('cpf')),
        nis: sanitizeInput(formData.get('nis')),
        categoria: sanitizeInput(formData.get('categoria')),
        protocolo: sanitizeInput(formData.get('protocolo')),
        situacao: sanitizeInput(formData.get('situacao')),
        observacoes: sanitizeInput(formData.get('observacoes'))
    };

    if (!validarCPF(data.cpf)) {
        showNotification('CPF inválido', 'error');
        return;
    }

    if (!validarNIS(data.nis)) {
        showNotification('NIS inválido', 'error');
        return;
    }

    try {
        showLoading('Criando registro de BPC...');
        await addBPC(data);
        showNotification('Registro de BPC criado com sucesso!', 'success');
        fecharModalCriacao('bpc');
        await loadAllData();
    } catch (error) {
        showNotification(error.message || 'Erro ao criar registro de BPC', 'error');
    } finally {
        hideLoading();
    }
}

// ===== FUNÇÕES DE API =====
async function apiRequest(endpoint, options = {}) {
    try {
        const token = localStorage.getItem('token');

        if (!token) {
            console.warn('Token não encontrado, redirecionando para login...');
            window.location.href = '/pages/login.html';
            throw new Error('Sessão expirada');
        }

        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                ...options.headers
            },
            ...options
        });

        if (response.status === 401) {
            console.warn('Token inválido ou expirado');
            localStorage.removeItem('token');
            window.location.href = '/pages/login.html';
            throw new Error('Sessão expirada');
        }

        if (!response.ok) {
            let errorMessage = `Erro HTTP: ${response.status}`;
            try {
                const errorData = await response.json();
                errorMessage = errorData.mensagem || errorData.message || errorMessage;
            } catch (e) {
                // Não conseguiu fazer parse do erro
            }
            throw new Error(errorMessage);
        }

        return await response.json();
    } catch (error) {
        console.error('Erro na requisição:', error);
        throw error;
    }
}

async function getMovimentacao() {
    return await apiRequest('/beneficios/movimentacao');
}

async function addMovimentacao(data) {
    return await apiRequest('/beneficios/movimentacao', {
        method: 'POST',
        body: JSON.stringify(data)
    });
}

async function deleteMovimentacao(id) {
    return await apiRequest(`/beneficios/movimentacao/${id}`, {
        method: 'DELETE'
    });
}

async function getBolsaFamilia() {
    return await apiRequest('/beneficios/bolsa');
}

async function addBolsaFamilia(data) {
    return await apiRequest('/beneficios/bolsa', {
        method: 'POST',
        body: JSON.stringify(data)
    });
}

async function deleteBolsaFamilia(id) {
    return await apiRequest(`/beneficios/bolsa/${id}`, {
        method: 'DELETE'
    });
}

async function getBeneficiosEventuais() {
    return await apiRequest('/beneficios/eventuais');
}

async function addBeneficioEventual(data) {
    return await apiRequest('/beneficios/eventuais', {
        method: 'POST',
        body: JSON.stringify(data)
    });
}

async function deleteBeneficioEventual(id) {
    return await apiRequest(`/beneficios/eventuais/${id}`, {
        method: 'DELETE'
    });
}

async function getBPC() {
    return await apiRequest('/beneficios/bpc');
}

async function addBPC(data) {
    return await apiRequest('/beneficios/bpc', {
        method: 'POST',
        body: JSON.stringify(data)
    });
}

async function deleteBPC(id) {
    return await apiRequest(`/beneficios/bpc/${id}`, {
        method: 'DELETE'
    });
}

// ===== FUNÇÕES AUXILIARES =====
function showLoading(message) {
    const overlay = document.getElementById('loading-overlay');
    const messageEl = document.getElementById('loading-message');
    if (overlay && messageEl) {
        messageEl.textContent = message;
        overlay.style.display = 'flex';
    }
}

function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        z-index: 10000;
        background: ${type === 'success' ? '#f0fdf4' : type === 'error' ? '#fef2f2' : '#eff6ff'};
        color: ${type === 'success' ? '#166534' : type === 'error' ? '#b91c1c' : '#1e40af'};
        border: 1px solid ${type === 'success' ? '#bbf7d0' : type === 'error' ? '#fecaca' : '#bfdbfe'};
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    `;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${escapeHtml(message)}</span>
        <button onclick="this.parentElement.remove()" style="background: none; border: none; margin-left: 1rem; cursor: pointer; font-size: 1.2rem;">&times;</button>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function sanitizeInput(input) {
    if (!input) return '';
    return String(input).trim();
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

function validarCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');

    if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) {
        return false;
    }

    let soma = 0;
    for (let i = 0; i < 9; i++) {
        soma += parseInt(cpf.charAt(i)) * (10 - i);
    }
    let resto = 11 - (soma % 11);
    let digito1 = resto >= 10 ? 0 : resto;

    if (digito1 !== parseInt(cpf.charAt(9))) {
        return false;
    }

    soma = 0;
    for (let i = 0; i < 10; i++) {
        soma += parseInt(cpf.charAt(i)) * (11 - i);
    }
    resto = 11 - (soma % 11);
    let digito2 = resto >= 10 ? 0 : resto;

    return digito2 === parseInt(cpf.charAt(10));
}

function validarNIS(nis) {
    nis = nis.replace(/\D/g, '');
    return nis.length === 11;
}

function badge(situacao){
    const map = {
        'Ativo':'status-ativo',
        'Suspenso':'status-suspenso',
        'Cancelado':'status-inativo',
        'Em Análise':'status-inativo',
        'Entregue':'status-ativo',
        'Concedido':'status-ativo',
        'ativo':'status-ativo',
        'suspenso':'status-suspenso',
        'cancelado':'status-inativo',
        'Indeferido': 'status-inativo'
    };
    const cls = map[situacao] || 'status-ativo';
    return `<span class="status-badge ${cls}">${escapeHtml(situacao)}</span>`;
}

function formatarData(data) {
    if (!data || data === '—') return '—';
    try {
        return new Date(data).toLocaleDateString('pt-BR');
    } catch {
        return '—';
    }
}

// ===== RENDERIZAÇÃO =====
async function renderMov() {
    try {
        const data = filteredData.mov.length > 0 ? filteredData.mov : currentData.mov;
        pagination.mov.total = data.length;
        const paginatedData = getPaginatedData(data, 'mov');

        if (paginatedData.length === 0) {
            tbodyMov.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #64748b;">Nenhum registro encontrado</td></tr>';
        } else {
            tbodyMov.innerHTML = paginatedData.map(r => `
                <tr>
                    <td>${escapeHtml(r.beneficio || '—')}</td>
                    <td>${escapeHtml(r.nome || '—')}</td>
                    <td>${escapeHtml(r.cpf || '—')}</td>
                    <td>${formatarData(r.data)}</td>
                    <td>${escapeHtml(r.acao || '—')}</td>
                    <td>${badge(r.situacao || 'Ativo')}</td>
                    <td>${escapeHtml(r.unidade || '—')}</td>
                    <td>
                        <div class="inline-actions">
                            <button class="btn btn--outline btn-sm" data-action="view" data-type="mov" data-id="${r.id}">
                                <i class="fa fa-eye"></i>
                            </button>
                            <button class="btn btn--outline btn-sm" data-action="edit" data-type="mov" data-id="${r.id}">
                                <i class="fa fa-pen"></i>
                            </button>
                            <button class="btn btn--outline btn-sm" data-action="delete" data-type="mov" data-id="${r.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        updatePaginationInfo('mov');
        addActionListeners();
    } catch (error) {
        console.error('Erro ao renderizar movimentação:', error);
        tbodyMov.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #ef4444;">Erro ao carregar dados</td></tr>';
    }
}

async function renderBolsa() {
    try {
        const data = filteredData.bolsa.length > 0 ? filteredData.bolsa : currentData.bolsa;
        pagination.bolsa.total = data.length;
        const paginatedData = getPaginatedData(data, 'bolsa');

        if (paginatedData.length === 0) {
            tbodyBolsa.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">Nenhum registro encontrado</td></tr>';
        } else {
            tbodyBolsa.innerHTML = paginatedData.map(r => `
                <tr>
                    <td>${escapeHtml(r.rf || '—')}</td>
                    <td>${escapeHtml(r.nis || '—')}</td>
                    <td>${escapeHtml(r.grupo || '—')}</td>
                    <td>${formatarData(r.entrada)}</td>
                    <td>${formatarData(r.renovacao)}</td>
                    <td>${badge(r.situacao || 'Ativo')}</td>
                    <td>
                        <div class="inline-actions">
                            <button class="btn btn--outline btn-sm" data-action="view" data-type="bolsa" data-id="${r.id}">
                                <i class="fa fa-eye"></i>
                            </button>
                            <button class="btn btn--outline btn-sm" data-action="edit" data-type="bolsa" data-id="${r.id}">
                                <i class="fa fa-pen"></i>
                            </button>
                            <button class="btn btn--outline btn-sm" data-action="delete" data-type="bolsa" data-id="${r.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        updatePaginationInfo('bolsa');
        addActionListeners();
    } catch (error) {
        console.error('Erro ao renderizar Bolsa Família:', error);
        tbodyBolsa.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #ef4444;">Erro ao carregar dados</td></tr>';
    }
}

async function renderEventuais() {
    try {
        const data = filteredData.eventuais.length > 0 ? filteredData.eventuais : currentData.eventuais;
        pagination.eventuais.total = data.length;
        const paginatedData = getPaginatedData(data, 'eventuais');

        if (paginatedData.length === 0) {
            tbodyEvent.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">Nenhum registro encontrado</td></tr>';
        } else {
            tbodyEvent.innerHTML = paginatedData.map(r => `
                <tr>
                    <td>${escapeHtml(r.tipo || '—')}</td>
                    <td>${escapeHtml(r.nome || '—')}</td>
                    <td>${escapeHtml(r.cpf || '—')}</td>
                    <td>R$ ${r.valor ? Number(r.valor).toFixed(2) : '0,00'}</td>
                    <td>${formatarData(r.data)}</td>
                    <td>${badge(r.situacao || 'Ativo')}</td>
                    <td>
                        <div class="inline-actions">
                            <button class="btn btn--outline btn-sm" data-action="view" data-type="eventual" data-id="${r.id}">
                                <i class="fa fa-eye"></i>
                            </button>
                            <button class="btn btn--outline btn-sm" data-action="edit" data-type="eventual" data-id="${r.id}">
                                <i class="fa fa-pen"></i>
                            </button>
                            <button class="btn btn--outline btn-sm" data-action="delete" data-type="eventual" data-id="${r.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        updatePaginationInfo('eventuais');
        addActionListeners();
    } catch (error) {
        console.error('Erro ao renderizar benefícios eventuais:', error);
        tbodyEvent.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #ef4444;">Erro ao carregar dados</td></tr>';
    }
}

async function renderBpc() {
    try {
        const data = filteredData.bpc.length > 0 ? filteredData.bpc : currentData.bpc;
        pagination.bpc.total = data.length;
        const paginatedData = getPaginatedData(data, 'bpc');

        if (paginatedData.length === 0) {
            tbodyBpc.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">Nenhum registro encontrado</td></tr>';
        } else {
            tbodyBpc.innerHTML = paginatedData.map(r => `
                <tr>
                    <td>${escapeHtml(r.nome || '—')}</td>
                    <td>${escapeHtml(r.cpf || '—')}</td>
                    <td>${escapeHtml(r.nis || '—')}</td>
                    <td>${escapeHtml(r.categoria || '—')}</td>
                    <td>${escapeHtml(r.protocolo || '—')}</td>
                    <td>${badge(r.situacao || 'Ativo')}</td>
                    <td>
                        <div class="inline-actions">
                            <button class="btn btn--outline btn-sm" data-action="view" data-type="bpc" data-id="${r.id}">
                                <i class="fa fa-eye"></i>
                            </button>
                            <button class="btn btn--outline btn-sm" data-action="edit" data-type="bpc" data-id="${r.id}">
                                <i class="fa fa-pen"></i>
                            </button>
                            <button class="btn btn--outline btn-sm" data-action="delete" data-type="bpc" data-id="${r.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        updatePaginationInfo('bpc');
        addActionListeners();
    } catch (error) {
        console.error('Erro ao renderizar BPC:', error);
        tbodyBpc.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #ef4444;">Erro ao carregar dados</td></tr>';
    }
}

async function renderLista() {
    try {
        const listaMov = currentData.mov.map(r => ({
            nome: r.nome,
            cpf: r.cpf,
            beneficio: r.beneficio,
            situacao: r.situacao,
            inicio: r.data,
            unidade: r.unidade
        }));

        const listaEventuais = currentData.eventuais.map(r => ({
            nome: r.nome,
            cpf: r.cpf,
            beneficio: r.tipo,
            situacao: r.situacao,
            inicio: r.data,
            unidade: 'CRAS/CREAS'
        }));

        const listaBpc = currentData.bpc.map(r => ({
            nome: r.nome,
            cpf: r.cpf,
            beneficio: 'BPC',
            situacao: r.situacao,
            inicio: '—',
            unidade: 'Sec. Assistência'
        }));

        const listaBolsa = currentData.bolsa.map(r => ({
            nome: r.rf,
            cpf: '—',
            beneficio: 'Bolsa Família',
            situacao: r.situacao,
            inicio: r.entrada,
            unidade: 'CRAS'
        }));

        let listaConsolidada = [...listaMov, ...listaEventuais, ...listaBpc, ...listaBolsa];

        const beneficioFiltro = document.getElementById('lista-beneficio')?.value;
        const nomeCpfFiltro = document.getElementById('lista-nomecpf')?.value.toLowerCase();
        const unidadeFiltro = document.getElementById('lista-unidade')?.value;

        if (beneficioFiltro) {
            listaConsolidada = listaConsolidada.filter(r => r.beneficio === beneficioFiltro);
        }
        if (nomeCpfFiltro) {
            listaConsolidada = listaConsolidada.filter(r =>
                (r.nome && r.nome.toLowerCase().includes(nomeCpfFiltro)) ||
                (r.cpf && r.cpf.includes(nomeCpfFiltro))
            );
        }
        if (unidadeFiltro) {
            listaConsolidada = listaConsolidada.filter(r => r.unidade === unidadeFiltro);
        }

        pagination.lista.total = listaConsolidada.length;
        const paginatedData = getPaginatedData(listaConsolidada, 'lista');

        if (paginatedData.length === 0) {
            tbodyLista.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">Nenhum registro encontrado</td></tr>';
        } else {
            tbodyLista.innerHTML = paginatedData.map(r => `
                <tr>
                    <td>${escapeHtml(r.nome || '—')}</td>
                    <td>${escapeHtml(r.cpf || '—')}</td>
                    <td>${escapeHtml(r.beneficio || '—')}</td>
                    <td>${badge(r.situacao || 'Ativo')}</td>
                    <td>${formatarData(r.inicio)}</td>
                    <td>${escapeHtml(r.unidade || '—')}</td>
                    <td>
                        <div class="inline-actions">
                            <button class="btn btn--outline btn-sm" data-action="view" data-type="lista">
                                <i class="fa fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        updatePaginationInfo('lista');
    } catch (error) {
        console.error('Erro ao renderizar lista:', error);
        tbodyLista.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #ef4444;">Erro ao carregar dados</td></tr>';
    }
}

function addActionListeners() {
    document.querySelectorAll('[data-action]').forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.addEventListener('click', handleActionClick);
    });
}

async function handleActionClick(e) {
    e.preventDefault();
    e.stopPropagation();

    const btn = e.currentTarget;
    const action = btn.dataset.action;
    const type = btn.dataset.type;
    const id = btn.dataset.id;

    if (action === 'delete') {
        if (confirm('Tem certeza que deseja excluir este registro?')) {
            try {
                showLoading('Excluindo registro...');

                if (type === 'mov') await deleteMovimentacao(id);
                if (type === 'bolsa') await deleteBolsaFamilia(id);
                if (type === 'eventual') await deleteBeneficioEventual(id);
                if (type === 'bpc') await deleteBPC(id);

                showNotification('Registro excluído com sucesso', 'success');
                await loadAllData();
            } catch (error) {
                showNotification(error.message || 'Erro ao excluir registro', 'error');
            } finally {
                hideLoading();
            }
        }
        return;
    }

    if (action === 'view' || action === 'edit') {
        abrirModal(type, id, action);
    }
}

function abrirModal(tipo, id, acao) {
    const modal = document.getElementById('modal-detalhes');
    const modalTitulo = document.getElementById('modal-titulo');
    const modalCorpo = document.getElementById('modal-corpo');

    modalTitulo.textContent = `${acao === 'view' ? 'Visualizar' : 'Editar'} ${tipo}`;

    modalCorpo.innerHTML = `
        <p class="helper">${acao === 'view' ? 'Visualizando' : 'Editando'} registro ${escapeHtml(id)} do tipo ${escapeHtml(tipo)}.</p>
        <div class="form-group">
            <label class="form-label">ID do Registro</label>
            <input class="form-input" value="${escapeHtml(id)}" readonly>
        </div>
        <div class="form-group">
            <label class="form-label">Ação</label>
            <select class="form-input">
                <option>Visualizar dados</option>
                <option>Editar informações</option>
                <option>Exportar registro</option>
            </select>
        </div>
    `;

    modal.classList.add('modal--open');
}

function fecharModal() {
    document.getElementById('modal-detalhes').classList.remove('modal--open');
}

async function loadAllData() {
    try {
        showLoading('Carregando dados...');

        const [mov, bolsa, eventuais, bpc] = await Promise.all([
            getMovimentacao().catch(() => []),
            getBolsaFamilia().catch(() => []),
            getBeneficiosEventuais().catch(() => []),
            getBPC().catch(() => [])
        ]);

        currentData = { mov, bolsa, eventuais, bpc };
        filteredData = { mov: [], bolsa: [], eventuais: [], bpc: [] };

        Object.keys(pagination).forEach(key => {
            pagination[key].page = 1;
        });

        await Promise.all([
            renderMov(),
            renderBolsa(),
            renderEventuais(),
            renderBpc(),
            renderLista()
        ]);

        hideLoading();
    } catch (error) {
        hideLoading();
        console.error('Erro ao carregar dados:', error);
        showNotification('Erro ao carregar dados do servidor', 'error');
    }
}

function filtrarMovimentacao() {
    const beneficio = document.getElementById('mov-beneficio')?.value;
    const nomeCpf = document.getElementById('mov-nomecpf')?.value.toLowerCase();
    const inicio = document.getElementById('mov-inicio')?.value;
    const fim = document.getElementById('mov-fim')?.value;
    const situacao = document.getElementById('mov-situacao')?.value;

    filteredData.mov = currentData.mov.filter(r => {
        if (beneficio && r.beneficio !== beneficio) return false;
        if (nomeCpf && !r.nome?.toLowerCase().includes(nomeCpf) && !r.cpf?.includes(nomeCpf)) return false;
        if (situacao && r.situacao !== situacao) return false;
        if (inicio && r.data && new Date(r.data) < new Date(inicio)) return false;
        if (fim && r.data && new Date(r.data) > new Date(fim)) return false;
        return true;
    });

    pagination.mov.page = 1;
    renderMov();
    showNotification(`${filteredData.mov.length} registros encontrados`, 'success');
}

function filtrarEventuais() {
    const tipo = document.getElementById('eventual-tipo')?.value;
    const nomeCpf = document.getElementById('eventual-nomecpf')?.value.toLowerCase();
    const inicio = document.getElementById('eventual-inicio')?.value;
    const fim = document.getElementById('eventual-fim')?.value;

    filteredData.eventuais = currentData.eventuais.filter(r => {
        if (tipo && r.tipo !== tipo) return false;
        if (nomeCpf && !r.nome?.toLowerCase().includes(nomeCpf) && !r.cpf?.includes(nomeCpf)) return false;
        if (inicio && r.data && new Date(r.data) < new Date(inicio)) return false;
        if (fim && r.data && new Date(r.data) > new Date(fim)) return false;
        return true;
    });

    pagination.eventuais.page = 1;
    renderEventuais();
    showNotification(`${filteredData.eventuais.length} registros encontrados`, 'success');
}

function filtrarBPC() {
    const nomeCpf = document.getElementById('bpc-nomecpf')?.value.toLowerCase();
    const nis = document.getElementById('bpc-nis')?.value;
    const situacao = document.getElementById('bpc-situacao')?.value;

    filteredData.bpc = currentData.bpc.filter(r => {
        if (nomeCpf && !r.nome?.toLowerCase().includes(nomeCpf) && !r.cpf?.includes(nomeCpf)) return false;
        if (nis && r.nis !== nis) return false;
        if (situacao && r.situacao !== situacao) return false;
        return true;
    });

    pagination.bpc.page = 1;
    renderBpc();
    showNotification(`${filteredData.bpc.length} registros encontrados`, 'success');
}

function limparFiltrosMov() {
    document.getElementById('mov-beneficio').value = '';
    document.getElementById('mov-nomecpf').value = '';
    document.getElementById('mov-inicio').value = '';
    document.getElementById('mov-fim').value = '';
    document.getElementById('mov-situacao').value = '';

    filteredData.mov = [];
    pagination.mov.page = 1;
    renderMov();
    showNotification('Filtros limpos', 'success');
}

function limparFiltrosLista() {
    document.getElementById('lista-beneficio').value = '';
    document.getElementById('lista-nomecpf').value = '';
    document.getElementById('lista-unidade').value = '';

    renderLista();
    showNotification('Filtros limpos', 'success');
}

function exportarBolsa() {
    try {
        const data = currentData.bolsa;
        const csv = convertToCSV(data);
        downloadFile(csv, 'bolsa-familia.csv', 'text/csv');
        showNotification('Dados exportados com sucesso!', 'success');
    } catch (error) {
        showNotification('Erro ao exportar dados', 'error');
    }
}

function exportarLista() {
    try {
        const listaMov = currentData.mov.map(r => ({
            nome: r.nome,
            cpf: r.cpf,
            beneficio: r.beneficio,
            situacao: r.situacao,
            inicio: r.data,
            unidade: r.unidade
        }));

        const listaEventuais = currentData.eventuais.map(r => ({
            nome: r.nome,
            cpf: r.cpf,
            beneficio: r.tipo,
            situacao: r.situacao,
            inicio: r.data,
            unidade: 'CRAS/CREAS'
        }));

        const listaBpc = currentData.bpc.map(r => ({
            nome: r.nome,
            cpf: r.cpf,
            beneficio: 'BPC',
            situacao: r.situacao,
            inicio: '—',
            unidade: 'Sec. Assistência'
        }));

        const listaBolsa = currentData.bolsa.map(r => ({
            nome: r.rf,
            cpf: '—',
            beneficio: 'Bolsa Família',
            situacao: r.situacao,
            inicio: r.entrada,
            unidade: 'CRAS'
        }));

        const listaConsolidada = [...listaMov, ...listaEventuais, ...listaBpc, ...listaBolsa];
        const csv = convertToCSV(listaConsolidada);
        downloadFile(csv, 'lista-beneficiarios.csv', 'text/csv');
        showNotification('Lista consolidada exportada com sucesso!', 'success');
    } catch (error) {
        showNotification('Erro ao exportar lista', 'error');
    }
}

function importarBolsa() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv,.xlsx,.xls';

    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            showLoading('Importando dados...');
            showNotification('Funcionalidade de importação em desenvolvimento', 'info');
        } catch (error) {
            showNotification('Erro ao importar arquivo', 'error');
        } finally {
            hideLoading();
        }
    };

    input.click();
}

function convertToCSV(data) {
    if (data.length === 0) return '';

    const headers = Object.keys(data[0]);
    const csvHeaders = headers.join(',');

    const csvRows = data.map(row => {
        return headers.map(header => {
            const value = row[header] || '';
            return `"${String(value).replace(/"/g, '""')}"`;
        }).join(',');
    });

    return [csvHeaders, ...csvRows].join('\n');
}

function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}
</script>

<style>
@keyframes spin {
    to { transform: rotate(360deg); }
}

.tabs {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid #e2e8f0;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.tab {
    padding: 0.75rem 1.5rem;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 500;
    color: #64748b;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: -2px;
}

.tab:hover {
    color: #483D8B;
    background: #f8f9fa;
}

.tab.active {
    color: #483D8B;
    border-bottom-color: #483D8B;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.modal--open {
    display: flex !important;
}

.modal__content {
    background: white;
    border-radius: 8px;
    padding: 2rem;
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
}

.modal__content--large {
    max-width: 800px;
}

.modal__close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #64748b;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: background 0.2s;
}

.modal__close:hover {
    background: #f1f5f9;
}

.modal__header {
    margin-bottom: 1.5rem;
    padding-right: 2rem;
}

.modal__header h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1e293b;
}

.modal__body {
    margin-bottom: 1.5rem;
}

.modal__footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding-top: 1rem;
    border-top: 1px solid #e2e8f0;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.form-grid .full-width {
    grid-column: 1 / -1;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-label {
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #1e293b;
    font-size: 0.875rem;
}

@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }

    .modal__content {
        max-width: 95%;
        padding: 1.5rem;
    }

    .tabs {
        overflow-x: auto;
    }
}
</style>
</body>
</html>
